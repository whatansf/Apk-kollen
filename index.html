<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>APK‑kollen – Systembolaget</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Google AdSense script -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4296884380555879"
     crossorigin="anonymous"></script>
<style>
:root {
  --bg: #f3f4f6;
  --card: #ffffff;
  --muted: #6b7280;
  --accent: #22c55e;
  --border: #d1d5db;
  --text: #111827;
  --high-apk: #22c55e;
  --med-apk: #facc15;
  --low-apk: #ef4444;
  --shadow: rgba(0,0,0,0.05);
}
body {
  margin:0; padding:1rem;
  background:linear-gradient(to bottom, #f3f4f6 0%, #e0f2fe 100%);
  font-family:system-ui, sans-serif;
  color:var(--text);
}
h1{text-align:center; font-size:1.8rem; margin-bottom:0.3rem; letter-spacing:1px; color:#1e40af;}
.small{text-align:center;color:var(--muted); margin-bottom:0.5rem; font-size:0.9rem;}
.legend{text-align:center;font-size:0.85rem;margin-bottom:1rem;color:var(--muted);}
.legend span{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:4px;vertical-align:middle;}
.controls{display:flex;flex-wrap:wrap;gap:0.5rem;justify-content:center;margin-bottom:1rem;}
input,select,button{padding:0.4rem 0.6rem;font-size:0.85rem;border-radius:6px;border:1px solid var(--border);background:#fff;color:var(--text);transition:all 0.2s;}
input::placeholder{color:#9ca3af;}
button{cursor:pointer;}
button:hover:not(:disabled){border-color:var(--accent); color:var(--accent);}
button:disabled{opacity:0.5; cursor:not-allowed;}
.product-list{display:flex; flex-direction:column; gap:0.5rem;}
.product-item{
  border-radius:12px;
  padding:0.6rem 0.8rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:0.9rem;
  transition:transform 0.2s, box-shadow 0.2s, opacity 0.5s;
  border:1px solid var(--border);
  background:var(--card);
  box-shadow:0 2px 6px var(--shadow);
  opacity:0;
  transform: translateY(10px);
}
.product-item.show{
  opacity:1;
  transform: translateY(0);
}
.product-item:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 12px var(--shadow);
}
.product-info{display:flex; flex-direction:column; gap:0.2rem;}
.apk-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:5px;vertical-align:middle;}
.fav{cursor:pointer;color:#9ca3af;margin-left:0.5rem;transition:color 0.2s;}
.fav.active{color:#ef4444;}
.link a{color:var(--accent); text-decoration:none;}
.link a:hover{text-decoration:underline;}
.pagination{margin-top:1rem;display:flex;justify-content:center;gap:0.5rem;font-size:0.85rem;}
.pagination button{padding:0.4rem 0.6rem;}
@media (max-width: 500px){
  .controls{flex-direction:column; gap:0.4rem;}
  .product-item{flex-direction:column; align-items:flex-start; gap:0.3rem;}
  .pagination{flex-direction:column; gap:0.3rem;}
}
</style>
</head>
<body>
<h1>APK‑kollen</h1>
<div class="small">Mest alkohol per krona – Systembolagets sortiment</div>
<div class="legend">APK: <span style="background: var(--high-apk);"></span> Hög | <span style="background: var(--med-apk);"></span> Medium | <span style="background: var(--low-apk);"></span> Låg</div>

<div class="controls">
<input type="text" id="search" placeholder="Sök namn...">
<select id="typeFilter"><option value="">Alla typer</option></select>
<input type="number" id="minPrice" placeholder="Min pris">
<input type="number" id="maxPrice" placeholder="Max pris">
<input type="number" id="minAbv" placeholder="Min %" step="0.1">
<button onclick="resetFilters()">Återställ</button>
</div>

<div class="product-list" id="productList"></div>

<div class="pagination">
<button id="prevBtn" onclick="prevPage()">⬅ Föregående</button>
<span id="pageInfo"></span>
<button id="nextBtn" onclick="nextPage()">Nästa ➡</button>
</div>

<script>
const favorites=new Set(JSON.parse(localStorage.getItem("favorites")||"[]"));
let drinks=[], filtered=[], page=1, pageSize=20;

// Fallback-data om API inte funkar
const LOCAL_DATA=[
  {id:1,name:"Absolut Vodka",type:"Spritsort",price:199,abv:40,volume:0.7},
  {id:2,name:"Norrlands Guld",type:"Öl",price:25,abv:5,volume:0.5},
  {id:3,name:"Coca-Cola Vodka",type:"Mix",price:49,abv:12,volume:0.5},
  {id:4,name:"Jack Daniels",type:"Spritsort",price:299,abv:40,volume:0.7},
  {id:5,name:"Rosévin",type:"Vin",price:89,abv:12,volume:0.75}
];

function calculateAPK(d){ return (d.abv*d.volume)/d.price; }
function saveFavorites(){ localStorage.setItem("favorites",JSON.stringify([...favorites])); }
function toggleFavorite(id){ if(favorites.has(id)) favorites.delete(id); else favorites.add(id); saveFavorites(); renderPage(); }

function createItemHTML(d){
  const apk=calculateAPK(d);
  let color=apk>0.1?'--high-apk':(apk>0.05?'--med-apk':'--low-apk');
  return `<div class="product-item">
    <div class="product-info">
      <span><span class="apk-dot" style="background: var(${color});"></span>${d.name}</span>
      <span class="badge">${d.type}</span>
      <span>Pris: ${d.price.toFixed(2)} kr | ABV: ${d.abv}% | Volym: ${d.volume} l | APK: ${apk.toFixed(4)}</span>
    </div>
    <div>
      <span class="fav ${favorites.has(d.id)?'active':''}" onclick="toggleFavorite(${d.id})">★</span>
      <span class="link"><a href="https://www.systembolaget.se/dryck/produkt/${d.id}" target="_blank" rel="noopener noreferrer">Systembolaget</a></span>
    </div>
  </div>`;
}

function renderPage(){
  const list=document.getElementById("productList");
  list.innerHTML="";
  const start=(page-1)*pageSize;
  const pageData=filtered.slice(start,start+pageSize);
  pageData.forEach(d=>{
    const div=document.createElement("div");
    div.innerHTML=createItemHTML(d);
    div.firstChild.classList.add("product-item");
    list.appendChild(div.firstChild);
    setTimeout(()=>div.firstChild.classList.add("show"), 50);
  });
  const totalPages=Math.max(1,Math.ceil(filtered.length/pageSize));
  document.getElementById("pageInfo").textContent=`Sida ${page} / ${totalPages} (${filtered.length} produkter)`;
  document.getElementById("prevBtn").disabled=page<=1;
  document.getElementById("nextBtn").disabled=page>=totalPages;
}

function applyFilters(){
  const q=document.getElementById("search").value.toLowerCase();
  const type=document.getElementById("typeFilter").value;
  const minPrice=parseFloat(document.getElementById("minPrice").value);
  const maxPrice=parseFloat(document.getElementById("maxPrice").value);
  const minAbv=parseFloat(document.getElementById("minAbv").value);
  filtered=drinks.filter(d=>{
    if(q&&!d.name.toLowerCase().includes(q))return false;
    if(type&&d.type!==type)return false;
    if(!isNaN(minPrice)&&d.price<minPrice)return false;
    if(!isNaN(maxPrice)&&d.price>maxPrice)return false;
    if(!isNaN(minAbv)&&d.abv<minAbv)return false;
    return true;
  });
  sortBy("apk");
}

function resetFilters(){document.getElementById("search").value="";document.getElementById("typeFilter").value="";document.getElementById("minPrice").value="";document.getElementById("maxPrice").value="";document.getElementById("minAbv").value="";applyFilters();}
function nextPage(){const totalPages=Math.ceil(filtered.length/pageSize); if(page<totalPages){page++; renderPage();}}
function prevPage(){if(page>1){page--; renderPage();}}

function sortBy(key){
  filtered.sort((a,b)=>{
    let va,vb;
    if(key==='apk'){va=calculateAPK(a);vb=calculateAPK(b);}
    else{va=a[key];vb=b[key];}
    return vb-va; // högsta först
  });
  page=1;
  renderPage();
}

async function loadData(){
  try{
    const res=await fetch("https://susbolaget.emrik.org/v1/products");
    const data=await res.json();
    drinks=data.map(d=>{
      const price=parseFloat(d.price);
      const abv=parseFloat(d.alcoholPercentage);
      const volume=parseFloat(d.volume)/1000;
      if(!price||!abv||!volume)return null;
      const type=d.categoryLevel1||"Okänt";
      return {id:d.productId,name:d.productNameBold||d.productNameThin||"Okänt",type,price,abv,volume};
    }).filter(Boolean);
  }catch(e){
    console.warn("API gick inte, använder fallback-data");
    drinks=[...LOCAL_DATA];
  }
  const types=new Set(drinks.map(d=>d.type));
  const select=document.getElementById("typeFilter");
  select.innerHTML='<option value="">Alla typer</option>';
  [...types].sort().forEach(t=>{const opt=document.createElement("option"); opt.value=t; opt.textContent=t; select.appendChild(opt);});
  filtered=[...drinks];
  sortBy("apk");
}

document.getElementById("search").addEventListener("input",applyFilters);
document.getElementById("typeFilter").addEventListener("change",applyFilters);
document.getElementById("minPrice").addEventListener("input",applyFilters);
document.getElementById("maxPrice").addEventListener("input",applyFilters);
document.getElementById("minAbv").addEventListener("input",applyFilters);

loadData();
</script>
</body>
</html>
